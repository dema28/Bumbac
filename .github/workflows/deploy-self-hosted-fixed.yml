name: 🚀 Self-Hosted CI/CD Pipeline (Fixed)

on:
  push:
    branches: [ main, master, develop ]

jobs:
  deploy-self-hosted:
    name: 🚀 Deploy on Self-Hosted Runner
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 🔍 Check Environment
        run: |
          echo "=== Working Directory ==="
          pwd
          ls -la
          echo "=== Java Version ==="
          java -version
          echo "=== Maven Version ==="
          mvn -version

      - name: 🛑 Stop Current Services
        run: |
          echo "=== Stopping current services ==="
          pkill -f "spring-boot:run" || true
          pkill -f "java.*app.jar" || true
          sleep 3

      - name: ☕ Build Backend
        working-directory: ./backend
        run: |
          echo "=== Building Backend ==="
          mvn clean package -DskipTests

      - name: 🚀 Deploy Application
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          echo "=== Copying JAR to apps directory ==="
          mkdir -p /home/denis/apps/bumbac
          cp -f backend/target/*.jar /home/denis/apps/bumbac/app.jar
          
          echo "=== Copying environment ==="
          if [ -f "/home/denis/projects/Bumbac/backend/.env" ]; then
            cp -f /home/denis/projects/Bumbac/backend/.env /home/denis/apps/bumbac/.env
          fi
          
          echo "=== Starting application ==="
          cd /home/denis/apps/bumbac
          nohup java -jar app.jar > app.log 2>&1 &

      - name: ✅ Verify Deployment
        run: |
          echo "=== Waiting for application startup ==="
          sleep 15
          
          echo "=== Checking backend health ==="
          for i in {1..30}; do
            if curl -f http://localhost:8080/actuator/health; then
              echo "✅ Backend is healthy!"
              break
            fi
            echo "Attempt $i/30: Backend not ready yet..."
            sleep 2
          done
          
          echo "=== Checking external access ==="
          curl -f https://qscfgrt657.duckdns.org/api/actuator/health
          echo "✅ External access works!"

      - name: 📧 Notify Success
        run: |
          echo "🎉 Deployment completed successfully!"
          echo "🌐 Site: https://qscfgrt657.duckdns.org/"
          echo "📚 API: https://qscfgrt657.duckdns.org/api
cd ~/projects/Bumbac
pwd

cat > .github/workflows/deploy-self-hosted-fixed.yml << 'EOF'
name: 🚀 Self-Hosted CI/CD Pipeline (Fixed)

on:
  push:
    branches: [ main, master, develop ]

jobs:
  deploy-self-hosted:
    name: 🚀 Deploy on Self-Hosted Runner
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4

      - name: 🔍 Check Environment
        run: |
          echo "=== Working Directory ==="
          pwd
          ls -la
          echo "=== Java Version ==="
          java -version

      - name: ☕ Build Backend
        working-directory: ./backend
        run: |
          echo "=== Building Backend ==="
          mvn clean package -DskipTests

      - name: 🚀 Deploy Application
        run: |
          echo "=== Stopping old processes ==="
          pkill -f "java.*app.jar" || true
          sleep 3
          
          echo "=== Copying JAR ==="
          mkdir -p /home/denis/apps/bumbac
          cp -f backend/target/*.jar /home/denis/apps/bumbac/app.jar
          
          echo "=== Starting app ==="
          cd /home/denis/apps/bumbac
          nohup java -jar app.jar > app.log 2>&1 &
          
          echo "=== Waiting for startup ==="
          sleep 15
          curl -f http://localhost:8080/actuator/health
          echo "✅ Deployment complete!"
